{% extends 'base.html' %}
{% block content %}
<div class="layout">
  <main class="main-col">
    <div class="card">
      <h1 style="margin: 0 0 8px 0; font-size: 28px; color: #333;"><i class="fa fa-lightbulb"></i> Suggest a Book to Read</h1>
      <p style="color: #666; margin: 0 0 24px 0;">AI-powered recommendation based on your library</p>

      <!-- Book Statistics -->
      <div style="background-color: #f0f8ff; padding: 16px; border-radius: 4px; margin-bottom: 24px; border-left: 4px solid #2196F3;">
        <p style="margin: 0; color: #333;"><strong>Analysis:</strong> Based on <strong>{{ book_count }}</strong> book{{ 's' if book_count != 1 else '' }} in your library</p>
        <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">
          {% set rated_books = books|selectattr('rating')|list %}
          <strong>{{ rated_books|length }}</strong> book{{ 's' if rated_books|length != 1 else '' }} rated • 
          {% if rated_books|length > 0 %}
            Average rating: <strong>{{ "%.1f"|format(rated_books|map(attribute='rating')|sum / rated_books|length) }}/10</strong>
          {% else %}
            No ratings yet
          {% endif %}
        </p>
      </div>

      <!-- Recommendation Box -->
      <div style="background-color: #fffacd; padding: 20px; border-radius: 8px; border: 2px solid #ffd700; margin-bottom: 24px;">
        <h2 style="margin: 0 0 16px 0; color: #333;"><i class="fa fa-sparkles"></i> AI Recommendations</h2>
        <p style="margin: 0 0 16px 0; color: #666; font-size: 14px;">Individual AI reviews for each book in your library:</p>
        <div style="display: grid; gap: 16px;">
          {% for book in books %}
            {% if book.ai_recommendation %}
            <div style="background-color: white; padding: 16px; border-radius: 4px; border-left: 4px solid #2196F3; line-height: 1.8; color: #333; font-size: 14px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                  <p style="margin: 0; font-weight: bold; color: #333;">{{ book.title }}</p>
                  <p style="margin: 4px 0 0 0; color: #666; font-size: 13px;">by {% if book.author %}{{ book.author.name }}{% else %}Unknown{% endif %}</p>
                </div>
                <button class="edit-review-btn" data-book-id="{{ book.id }}" style="background-color: #ff9800; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; border: none; cursor: pointer;">
                  <i class="fa fa-edit"></i> Edit
                </button>
              </div>
              <div style="background-color: #f9f9f9; padding: 12px; border-radius: 4px; margin-bottom: 8px; white-space: pre-wrap; line-height: 1.6;">{{ book.ai_recommendation }}</div>
              <form method="post" action="{{ url_for('ai_review_book', book_id=book.id) }}" style="margin: 0;" class="ai-review-form">
                <button type="submit" class="btn ai-generate-btn" style="background-color: #4CAF50; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; border: none; cursor: pointer;">
                  <i class="fa fa-refresh"></i> Refresh
                </button>
              </form>
            </div>
            {% endif %}
          {% endfor %}
        </div>
        {% if recommendation == 'No cached AI recommendations.' %}
        <div style="background-color: white; padding: 16px; border-radius: 4px; text-align: center; color: #999;">
          <p style="margin: 0;"><i class="fa fa-info-circle"></i> No AI recommendations yet. Click "Get/Update AI Review" on any book below.</p>
        </div>
        {% endif %}
      </div>

      <!-- Your Library Summary -->
      <div style="background-color: #f9f9f9; padding: 16px; border-radius: 4px;">
        <h3 style="margin: 0 0 12px 0; color: #333;"><i class="fa fa-books"></i> Your Library (Used for Analysis)</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
          {% for book in books %}
          <div style="background-color: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
            <p style="margin: 0 0 4px 0; font-weight: bold; color: #333; word-break: break-word;">{{ book.title }}</p>
            <p style="margin: 0 0 4px 0; color: #666; font-size: 13px;">
              {% if book.author %}
                by {{ book.author.name }}
              {% else %}
                by Unknown
              {% endif %}
            </p>
            {% if book.rating %}
            <p style="margin: 0 0 8px 0; color: #ff9800; font-size: 14px;">
              <span style="color: #ff9800;">{{ '★' * book.rating }}</span><span style="color: #ddd;">{{ '★' * (10 - book.rating) }}</span>
              <strong>{{ book.rating }}/10</strong>
            </p>
            {% else %}
            <p style="margin: 0 0 8px 0; color: #999; font-size: 13px; font-style: italic;">Not rated</p>
            {% endif %}
            {% if book.ai_recommendation %}
            <p style="margin: 0 0 8px 0; font-size: 12px; color: #4CAF50;">
              <i class="fa fa-check-circle"></i> AI Review cached
            </p>
            {% endif %}
            <form method="post" action="{{ url_for('ai_review_book', book_id=book.id) }}" style="margin-top: 8px;" class="ai-review-form">
              <button type="submit" class="btn ai-generate-btn" style="background-color: #2196F3; color: white; padding: 6px 12px; border-radius: 4px; font-size: 13px; border: none; cursor: pointer;">
                <i class="fa fa-magic"></i> Get/Update AI Review
              </button>
            </form>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Action Buttons -->
      <div style="display: flex; gap: 8px; margin-top: 24px; flex-wrap: wrap;">
        <a href="{{ url_for('home') }}" class="btn" style="background-color: #6c757d; color: white; text-decoration: none; padding: 10px 16px; border-radius: 4px; display: inline-block;">
          <i class="fa fa-arrow-left"></i> Back to Library
        </a>
        <a href="{{ url_for('add_book') }}" class="btn" style="background-color: #4CAF50; color: white; text-decoration: none; padding: 10px 16px; border-radius: 4px; display: inline-block;">
          <i class="fa fa-plus"></i> Add a Book
        </a>
        <a href="{{ url_for('recommend') }}" class="btn" style="background-color: #2196F3; color: white; text-decoration: none; padding: 10px 16px; border-radius: 4px; display: inline-block;">
          <i class="fa fa-refresh"></i> Get Another Recommendation
        </a>
      </div>
    </div>
  </main>

  <aside class="side-col">
    <div class="card">
      <h3 style="margin: 0 0 12px 0;"><i class="fa fa-lightbulb"></i> How It Works</h3>
      <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.6;">
        This AI recommendation engine analyzes:
      </p>
      <ul style="margin: 0 0 0 16px; padding: 0; font-size: 14px; color: #666;">
        <li>Books in your library</li>
        <li>Book genres and themes</li>
        <li>Your ratings (if you've rated books)</li>
        <li>Author styles and topics</li>
      </ul>
      <p style="margin: 12px 0 0 0; font-size: 14px; line-height: 1.6; color: #666;">
        Based on this analysis, it recommends a book that matches your reading preferences!
      </p>
    </div>

    <div class="card aside-links">
      <h3 style="margin: 0 0 12px 0;">Quick Links</h3>
      <p><a class="btn" href="{{ url_for('home') }}"><i class="fa fa-home"></i> Library</a></p>
      <p><a class="btn" href="{{ url_for('add_book') }}"><i class="fa fa-plus"></i> Add Book</a></p>
      <p><a class="btn" href="{{ url_for('add_author') }}"><i class="fa fa-user-plus"></i> Add Author</a></p>
    </div>
  </aside>
</div>

<!-- Edit Review Modal -->
<div id="editReviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; padding: 24px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <h2 style="margin: 0 0 16px 0; color: #333;">Edit AI Review</h2>
    <form id="editReviewForm" method="post" action="">
      <div style="margin-bottom: 16px;">
        <label for="reviewText" style="display: block; margin-bottom: 8px; color: #333; font-weight: bold;">Review Content (Markdown format):</label>
        <textarea id="reviewText" name="ai_recommendation" style="width: 100%; height: 300px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 14px; resize: vertical;"></textarea>
      </div>
      <div style="display: flex; gap: 8px;">
        <button type="submit" class="btn" style="background-color: #4CAF50; color: white; padding: 10px 16px; border-radius: 4px; border: none; cursor: pointer; flex: 1;">
          <i class="fa fa-save"></i> Save Changes
        </button>
        <button type="button" id="closeEditModal" class="btn" style="background-color: #6c757d; color: white; padding: 10px 16px; border-radius: 4px; border: none; cursor: pointer; flex: 1;">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
  <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
    <div style="margin-bottom: 20px;">
      <div style="width: 60px; height: 60px; margin: 0 auto; border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>
    <h2 style="margin: 0 0 8px 0; color: #333; font-size: 20px;">Generating AI Review</h2>
    <p style="margin: 0; color: #666; font-size: 14px;">Please wait while we fetch the review from GPT...</p>
  </div>
</div>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<script>
document.querySelectorAll('.edit-review-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const bookId = this.dataset.bookId;
    const reviewDiv = this.closest('div').nextElementSibling;
    const reviewText = reviewDiv ? reviewDiv.textContent.trim() : '';
    
    const form = document.getElementById('editReviewForm');
    form.action = '/book/' + bookId + '/edit_review';
    document.getElementById('reviewText').value = reviewText;
    
    document.getElementById('editReviewModal').style.display = 'flex';
  });
});

document.getElementById('closeEditModal').addEventListener('click', function() {
  document.getElementById('editReviewModal').style.display = 'none';
});

document.getElementById('editReviewModal').addEventListener('click', function(e) {
  if (e.target === this) {
    this.style.display = 'none';
  }
});

// Loading indicator for AI generation
document.querySelectorAll('.ai-review-form').forEach(form => {
  form.addEventListener('submit', function(e) {
    // Show loading modal
    document.getElementById('loadingModal').style.display = 'flex';
  });
});
</script>
{% endblock %}
