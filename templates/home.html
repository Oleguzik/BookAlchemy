{% extends 'base.html' %}
{% block content %}
<div class="layout">
  <main class="main-col">
    <div class="card">
      <h2>Books</h2>
        <!-- Global search is in header; do not repeat the form here to avoid duplication. -->
        <!-- Sorting is provided via the clickable headers below (Title / Author). -->
        {# Show success message from redirects, e.g., 'author_added' or 'book_added' #}
        {% if request.args.get('success') %}
          <p style="color:green; margin:8px 0;">{% if request.args.get('success') == 'author_added' %}Author added successfully.{% elif request.args.get('success') == 'book_added' %}Book added successfully.{% else %}Operation completed successfully.{% endif %}</p>
        {% endif %}
        {# Clickable column headers that toggle sort direction. Using emojis as icons. #}
        <!-- Empty spacer for header controls -->
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
        </div>
        <div style="display:flex; gap:24px; align-items:center; margin-bottom:8px;">
          <a href="{{ url_for('home', sort='title', order=('desc' if sort_by == 'title' and order == 'asc' else 'asc'), q=q, scope=scope) }}" style="text-decoration:none; font-weight:bold;"><i class="fa fa-book"></i> Title {% if sort_by == 'title' %}{% if order=='asc' %}<i class="fa fa-arrow-up"></i>{% else %}<i class="fa fa-arrow-down"></i>{% endif %}{% endif %}</a>
          <a href="{{ url_for('home', sort='author', order=('desc' if sort_by == 'author' and order == 'asc' else 'asc'), q=q, scope=scope) }}" style="text-decoration:none; font-weight:bold;"><i class="fa fa-user"></i> Author {% if sort_by == 'author' %}{% if order=='asc' %}<i class="fa fa-arrow-up"></i>{% else %}<i class="fa fa-arrow-down"></i>{% endif %}{% endif %}</a>
        </div>
        {% if q and scope == 'authors' and authors_search|length == 0 %}
          <p class="meta" style="color:#a00">No books found for "{{ q }}"</p>
        {% elif q and scope == 'authors' %}
          <p class="meta" style="color:green">Found {{ authors_search|length }} author{{ 's' if authors_search|length != 1 }} for "{{ q }}"</p>
        {% elif q %}
          <p class="meta" style="color:green">Found {{ books|length }} result{{ 's' if books|length != 1 }} for "{{ q }}"</p>
        {% endif %}
        {# no_results text removed to avoid duplication (we show 'Found X results' or clear message above) #}
        {% if scope == 'authors' and authors_search %}
          {% for author in authors_search %}
            <div class="book-row">
              <div>
                <h3 class="title">{{ author.name | highlight(q) }} <small class="meta">({{ author.books|length }} books)</small></h3>
                <p class="meta">{{ author.birth_date or '' }} {% if author.date_of_death %}â€“ {{ author.date_of_death }}{% endif %}</p>
              </div>
            </div>
          {% endfor %}
        {% else %}
          {% for book in books %}
      <div class="book-row">
      {% if book.cover_url %}
      <img src="{{ book.cover_url }}" alt="cover" class="book-cover" style="width:72px; height:auto;" onerror="this.style.display='none'" />
      {% endif %}
      <div>
        <h3 class="title">{{ book.title | highlight(q) }}</h3>
        <p class="meta">by {{ (book.author.name if book.author else 'Unknown') | highlight(q) }} {% if book.author %}<span class="meta">({{ book.author.books|length }} books)</span>{% endif %}</p>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <form method="POST" action="{{ url_for('delete_book', book_id=book.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this book?');">
          <button type="submit" class="btn btn-danger" style="background-color:#d9534f; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;"><i class="fa fa-trash"></i> Delete</button>
        </form>
      </div>
    </div>
          {% endfor %}
        {% endif %}
    </div>
  </main>

  <aside class="side-col">
      <div class="card aside-links">
        <h3>Actions</h3>
        <p><a class="btn" href="{{ url_for('add_author', sort=sort_by, order=order, q=q) }}"><i class="fa fa-user-plus"></i> Add Author</a></p>
        <p><a class="btn" href="{{ url_for('add_book', sort=sort_by, order=order, q=q) }}"><i class="fa fa-book"></i> Add Book</a></p>
        <p class="meta">Authors: <strong>{{ total_authors }}</strong></p>
        <p class="meta">Books: <strong>{{ total_books }}</strong></p>
        <p class="meta"><a href="{{ url_for('home', sort=sort_by, order=order) }}">View All</a></p>
      </div>
    </aside>
</div>
{% endblock %}

  </body>
</html>