{% extends 'base.html' %}
{% block content %}
<div class="layout">
  <main class="main-col">
    <div class="card">
      <h2>Books</h2>
        <!-- Global search is in header; do not repeat the form here to avoid duplication. -->
        <!-- Sorting is provided via the clickable headers below (Title / Author). -->
        {# Show success message from redirects, e.g., 'author_added' or 'book_added' #}
        {% if request.args.get('success') %}
          <p style="color:green; margin:8px 0;">{% if request.args.get('success') == 'author_added' %}Author added successfully.{% elif request.args.get('success') == 'book_added' %}Book added successfully.{% else %}Operation completed successfully.{% endif %}</p>
        {% endif %}
        {# Clickable column headers that toggle sort direction. Using emojis as icons. #}
        <!-- Empty spacer for header controls -->
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
        </div>
        <div style="display:flex; gap:24px; align-items:center; margin-bottom:8px;">
          <a href="{{ url_for('home', sort='title', order=('desc' if sort_by == 'title' and order == 'asc' else 'asc'), q=q, scope=scope) }}" style="text-decoration:none; font-weight:bold;"><i class="fa fa-book"></i> Title {% if sort_by == 'title' %}{% if order=='asc' %}<i class="fa fa-arrow-up"></i>{% else %}<i class="fa fa-arrow-down"></i>{% endif %}{% endif %}</a>
          <a href="{{ url_for('home', sort='author', order=('desc' if sort_by == 'author' and order == 'asc' else 'asc'), q=q, scope=scope) }}" style="text-decoration:none; font-weight:bold;"><i class="fa fa-user"></i> Author {% if sort_by == 'author' %}{% if order=='asc' %}<i class="fa fa-arrow-up"></i>{% else %}<i class="fa fa-arrow-down"></i>{% endif %}{% endif %}</a>
          <a href="{{ url_for('home', sort='rating', order=('desc' if sort_by == 'rating' and order == 'asc' else 'asc'), q=q, scope=scope) }}" style="text-decoration:none; font-weight:bold;"><i class="fa fa-star"></i> Rating {% if sort_by == 'rating' %}{% if order=='asc' %}<i class="fa fa-arrow-up"></i>{% else %}<i class="fa fa-arrow-down"></i>{% endif %}{% endif %}</a>
        </div>
        {% if q and scope == 'authors' and authors_search|length == 0 %}
          <p class="meta" style="color:#a00">No books found for "{{ q }}"</p>
        {% elif q and scope == 'authors' %}
          <p class="meta" style="color:green">Found {{ authors_search|length }} author{{ 's' if authors_search|length != 1 }} for "{{ q }}"</p>
        {% elif q %}
          <p class="meta" style="color:green">Found {{ books|length }} result{{ 's' if books|length != 1 }} for "{{ q }}"</p>
        {% endif %}
        {# no_results text removed to avoid duplication (we show 'Found X results' or clear message above) #}
        {% if scope == 'authors' and authors_search %}
          {% for author in authors_search %}
            <div class="book-row">
              <div>
                <h3 class="title">
                  <a href="{{ url_for('author_detail', author_id=author.id) }}" style="color: #333; text-decoration: none;">{{ author.name | highlight(q) }}</a>
                  <small class="meta">({{ author.books|length }} books)</small>
                </h3>
                <p class="meta">{{ author.birth_date or '' }} {% if author.date_of_death %}– {{ author.date_of_death }}{% endif %}</p>
              </div>
              <div style="margin-left:auto; display:flex; gap:8px;">
                <form method="POST" action="{{ url_for('delete_author', author_id=author.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete &quot;{{ author.name }}&quot; and ALL their books? This cannot be undone.');">
                  <button type="submit" class="btn btn-danger" style="background-color:#d9534f; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;"><i class="fa fa-trash"></i> Delete Author</button>
                </form>
              </div>
            </div>
          {% endfor %}
        {% else %}
          {% for book in books %}
      <div class="book-row">
      {% if book.cover_url %}
      <img src="{{ book.cover_url }}" alt="cover" class="book-cover" style="width:72px; height:auto;" onerror="this.style.display='none'" />
      {% endif %}
      <div>
        <h3 class="title">
          <a href="{{ url_for('book_detail', book_id=book.id) }}" style="color: #333; text-decoration: none;">{{ book.title | highlight(q) }}</a>
        </h3>
        <p class="meta">by 
          {% if book.author %}
          <a href="{{ url_for('author_detail', author_id=book.author.id) }}" style="color: #2196F3; text-decoration: none;">{{ book.author.name | highlight(q) }}</a>
          {% else %}
          <span>Unknown</span>
          {% endif %}
          {% if book.author %}<span class="meta">({{ book.author.books|length }} books)</span>{% endif %}
        </p>
        {% if book.rating %}
        <p class="meta" style="margin-top: 4px;">
          <span style="color: #ff9800;">{{ '★' * book.rating }}</span><span style="color: #ddd;">{{ '★' * (10 - book.rating) }}</span>
          <strong>{{ book.rating }}/10</strong>
        </p>
        {% else %}
        <p class="meta" style="margin-top: 4px; color: #999;">Not rated</p>
        {% endif %}
        {% if book.ai_recommendation %}
        <p class="meta" style="margin-top: 4px;">
          <span style="display: inline-block; background-color: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
            <i class="fa fa-check-circle"></i> AI Review
          </span>
        </p>
        {% endif %}
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; flex-wrap: wrap;">
        {% if book.rating %}
        <button type="button" class="btn rate-button" style="background-color:#FF9800; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;" data-book-id="{{ book.id }}"><i class="fa fa-edit"></i> Re-rate</button>
        {% else %}
        <button type="button" class="btn rate-button" style="background-color:#4CAF50; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;" data-book-id="{{ book.id }}"><i class="fa fa-star"></i> Rate</button>
        {% endif %}
        {% if book.ai_recommendation %}
        <a href="{{ url_for('recommend') }}" class="btn" style="background-color:#2196F3; color:white; text-decoration:none; padding:6px 12px; border-radius:4px; display:inline-block;"><i class="fa fa-eye"></i> View Review</a>
        {% else %}
        <a href="{{ url_for('recommend') }}" class="btn" style="background-color:#2196F3; color:white; text-decoration:none; padding:6px 12px; border-radius:4px; display:inline-block;"><i class="fa fa-magic"></i> Generate Review</a>
        {% endif %}
        <form method="POST" action="{{ url_for('delete_book', book_id=book.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this book?');">
          <button type="submit" class="btn btn-danger" style="background-color:#d9534f; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;"><i class="fa fa-trash"></i> Delete</button>
        </form>
      </div>
    </div>
          {% endfor %}
        {% endif %}
    </div>
  </main>

  <aside class="side-col">
      <div class="card aside-links">
        <h3>Actions</h3>
        <p><a class="btn" href="{{ url_for('add_author', sort=sort_by, order=order, q=q) }}"><i class="fa fa-user-plus"></i> Add Author</a></p>
        <p><a class="btn" href="{{ url_for('add_book', sort=sort_by, order=order, q=q) }}"><i class="fa fa-book"></i> Add Book</a></p>
        <p><a class="btn" href="{{ url_for('recommend') }}" style="background-color: #FF9800;"><i class="fa fa-lightbulb"></i> Suggest a Book</a></p>
        <p class="meta">Authors: <strong>{{ total_authors }}</strong></p>
        <p class="meta">Books: <strong>{{ total_books }}</strong></p>
        <p class="meta"><a href="{{ url_for('home', sort=sort_by, order=order) }}">View All</a></p>
      </div>
    </aside>
</div>

<!-- Quick Rating Modal -->
<div id="quickRatingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); width: 90%; max-width: 400px;">
    <h2 style="margin: 0 0 16px 0;" id="quickRatingTitle">Rate This Book</h2>
    <form method="POST" id="quickRatingForm" style="margin-bottom: 16px;">
      <div style="margin-bottom: 16px;">
        <label for="quick_rating_slider" style="display: block; margin-bottom: 8px; font-weight: bold;">Rating (1-10)</label>
        <div style="display: flex; align-items: center; gap: 12px;">
          <input type="range" id="quick_rating_slider" name="rating" min="1" max="10" value="5" style="width: 100%; max-width: 250px;">
          <span id="quick_rating_display" style="font-weight: bold; font-size: 18px; min-width: 50px; text-align: center;">5</span>
        </div>
        <div style="margin-top: 12px; font-size: 20px; text-align: center;">
          <span id="quick_rating_stars" style="color: #ff9800;">★★★★★☆☆☆☆☆</span>
        </div>
      </div>
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button type="button" class="btn" onclick="closeQuickRating()" style="background-color: #999; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
          Cancel
        </button>
        <button type="submit" class="btn" style="background-color: #4CAF50; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
          <i class="fa fa-save"></i> Save Rating
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentBookId = null;

  function openRatingQuick(bookId) {
    currentBookId = bookId;
    const modal = document.getElementById('quickRatingModal');
    const form = document.getElementById('quickRatingForm');
    form.action = '/book/' + bookId + '/rate';
    modal.style.display = 'flex';
    
    // Reset slider to 5 and update display
    const slider = document.getElementById('quick_rating_slider');
    slider.value = 5;
    document.getElementById('quick_rating_display').textContent = '5';
    document.getElementById('quick_rating_stars').innerHTML = '★★★★★☆☆☆☆☆';
    
    // Focus on the slider
    setTimeout(() => {
      slider.focus();
    }, 100);
  }

  function closeQuickRating() {
    const modal = document.getElementById('quickRatingModal');
    modal.style.display = 'none';
  }

  // Update rating display in real-time
  const quickRatingSlider = document.getElementById('quick_rating_slider');
  if (quickRatingSlider) {
    quickRatingSlider.addEventListener('input', function() {
      document.getElementById('quick_rating_display').textContent = this.value;
      const filledStars = '★'.repeat(this.value);
      const emptyStars = '☆'.repeat(10 - this.value);
      document.getElementById('quick_rating_stars').innerHTML = filledStars + emptyStars;
    });
  }

  // Close modal when clicking outside
  const modal = document.getElementById('quickRatingModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeQuickRating();
      }
    });
  }

  // Attach event listeners to all rate buttons after DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    const rateButtons = document.querySelectorAll('.rate-button');
    rateButtons.forEach(button => {
      button.addEventListener('click', function() {
        const bookId = this.dataset.bookId;
        openRatingQuick(bookId);
      });
    });
  });
</script>

{% endblock %}
